// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.0;

import {Test} from "forge-std/Test.sol";

import {AzureTDX, AzureTDXAttestationDocument} from "../src/AzureTDX.sol";

contract AzureTDXTest is Test {
    using AzureTDXAttestationDocument for AzureTDX.AttestationDocument;

    function testValidate() public view {
        AzureTDX.AttestationDocument memory attestationDocument = AzureTDX.AttestationDocument({
            attestation: AzureTDX.Attestation({
                tpmQuote: AzureTDX.TPMQuote({
                    quote: hex"ff54434780180022000bce04664aa230c8a92603c9eb4fd4167d9e8e4bbe2b1fcc20878634d321446074002019d3a0a35ce74a755e12231b6429d87e065e49e1137a6c367376141ebac32f5b00000000009b8490000000010000000001202003120012000300000001000b03ffffff0020b551100a22bd7da6b5531a2c02b90c57ae7a8421ee7ed61c831da7692df71ff1",
                    rsaSignature: hex"1d93ba45381c448c8ab6cf944e610f108b42b56f757daece33303f7b2b8c3e452770b735b4247dc4a5a194df7fb2434c6c51c4ce33e7648466da404b54dae9b04b882cd72f17cbede098cf9e9846c801811494ff0ea2209daf19d13dfe19d6bbc07482f3e99c5fa267f3792f7f89d4c5c47bf5d247f4ca726d4a5e31695945f0cbee551d52cc33d8a9f26cea217c15bff908440ad313e2c4cdf469a44f6b2284bfafe9413928722558b858d3588dd42948afd86722b8116ea224c1ff33fa68efa8301aad79d21a93e1cc7920a38f5c18ad629f4b2a2a6826643cc04d24ef04e51b37eb57ebdaebb174ccb73fae48a84bff7c30fd8aab0e5a48c99fac64b47311",
                    pcrs: [
                        bytes32(0x533ac42025dd79577672e40d03af4a2aff53f983db38652bac017a492215fffa),
                        bytes32(0x3d458cfe55cc03ea1f443f1562beec8df51c75e14a9fcf9a7234a13f198e7969),
                        bytes32(0x3d458cfe55cc03ea1f443f1562beec8df51c75e14a9fcf9a7234a13f198e7969),
                        bytes32(0x3d458cfe55cc03ea1f443f1562beec8df51c75e14a9fcf9a7234a13f198e7969),
                        bytes32(0xddc4c72f849e01d1c291257bc683c6c75dc899bdcd236a50d47969f4604b1357),
                        bytes32(0xbe1a864a1fc9e2cc68dd701803241179f4a57f14d204b7ca3fab60806c961834),
                        bytes32(0xb4336448b38636e6f782f658595a9541d32440da06ec5bfd47bb7677141b58e9),
                        bytes32(0x124daf47b4d67179a77dc3c1bcca198ae1ee1d094a2a879974842e44ab98bb06),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000),
                        bytes32(0x69e815742fc35332d14b1bfcc6a3942f12c5f1171ef2a0a34eb652cbaaaecb99),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000),
                        bytes32(0xe4b8668ee696aeba9ebbbb5a72fc52f602d34810a73d51cc0dff814f9869eaa5),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000),
                        bytes32(0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff),
                        bytes32(0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff),
                        bytes32(0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff),
                        bytes32(0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff),
                        bytes32(0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff),
                        bytes32(0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff),
                        bytes32(0x0000000000000000000000000000000000000000000000000000000000000000)
                    ]
                })
            }),
            instanceInfo: AzureTDX.InstanceInfo({
                attestationReport: hex"040002008100000000000000939a7233f79c4ca9940a0db3957f0607b020b18cdec518bf89ad8dd257db920700000000040107000000000000000000000000009790d89a10210ec6968a773cee2ca05b5aa97309f36727a968527be4606fc19e6f73acce350946c9d46a9bf7a63f843000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e718060000000000bb379f8e734a755832509f61403f99db2258a70a01e1172a499d6d364101b0675455b4e372a35c1f006541f2de0d7154000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000855277af45d8f952fd3b1fe1633601968e9a0e24e9ea01d8ff63ebe374d189b50000000000000000000000000000000000000000000000000000000000000000cc10000001cda3dff59ace2a1cfa9e134a7002906a4d81d0b7abc2e774d4ecb5f6871d888ee10464f14822f2ddf3acd14df4e04d362522ed44e1fc1826c2ec9404be65f429e03ddce3fcffbf4effe0caf7fc853b167087a46e7cfee054d921f69a808b22ae3f2118ffc151cf8a576130493b40600f28176f1de965bec2f597e660a4522f0600461000000707181a03ff0003000000000000000000000000000000000000000000000000000000000000000000000000000000001500000000000000e700000000000000e5a3a7b5d830c2953b98534c6c59a3a34fdc34e933f7f5898f0a85cf08846bca0000000000000000000000000000000000000000000000000000000000000000dc9e2a7c6f948f17474e34a7fc43ed030f7c1563f1babddf6340c82e0e54a8c500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000991d6f91e2a4f7328cd0bd1e2b2a4fcfe261f6df61df44bdcf708e06c40761d700000000000000000000000000000000000000000000000000000000000000001c1589e4e05d1fa68748e4903b6d1d6c4d23cc63a72ea237e9a6d83792417735b18cea498384d3312848b1c7c6efc128501ff164ae50a739dc1ea6343580ec762000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f05005e0e00002d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d49494538544343424a616741774942416749554a4b734d705543587a6e38653076774539737644565775422f363877436759494b6f5a497a6a3045417749770a634445694d434147413155454177775a535735305a577767553064594946424453794251624746305a6d397962534244515445614d42674741315545436777520a535735305a577767513239796347397959585270623234784644415342674e564241634d43314e68626e526849454e7359584a684d51737743515944565151490a44414a445154454c4d416b474131554542684d4356564d774868634e4d6a51774e5445344d5441314d7a51315768634e4d7a45774e5445344d5441314d7a51310a576a42774d534977494159445651514444426c4a626e526c624342545231676755454e4c49454e6c636e52705a6d6c6a5958526c4d526f77474159445651514b0a4442464a626e526c6243424462334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e560a4241674d416b4e424d517377435159445651514745774a56557a425a4d424d4742797147534d34394167454743437147534d34394177454841304941424e346a0a4e736c447079397643666d554f4e3273416b386d69694e53414c5268676644463147746f4262784e573677617755467a4f4e7565652f4b514d555541336e73790a6c4534564963626a2b665572506b426833694b6a67674d4d4d4949444344416642674e5648534d4547444157674253566231334e765276683655424a796454300a4d383442567776655644427242674e56485238455a4442694d47436758714263686c706f64485277637a6f764c32467761533530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c334e6e6543396a5a584a3061575a7059324630615739754c3359304c33426a61324e796244396a595431770a624746305a6d397962535a6c626d4e765a476c755a7a316b5a584977485159445652304f42425945464f6a316a4f79462b3752476273692b446448566c57754d0a7a3375574d41344741315564447745422f775145417749477744414d42674e5648524d4241663845416a41414d4949434f51594a4b6f5a496876684e415130420a424949434b6a4343416959774867594b4b6f5a496876684e41513042415151515375377254466f423661464163646456384c2b696f7a434341574d47436971470a534962345451454e41514977676746544d42414743797147534962345451454e41514942416745484d42414743797147534962345451454e41514943416745480a4d42414743797147534962345451454e41514944416745434d42414743797147534962345451454e41514945416745434d42414743797147534962345451454e0a41514946416745444d42414743797147534962345451454e41514947416745424d42414743797147534962345451454e41514948416745414d424147437971470a534962345451454e41514949416745444d42414743797147534962345451454e4151494a416745414d42414743797147534962345451454e4151494b416745410a4d42414743797147534962345451454e4151494c416745414d42414743797147534962345451454e4151494d416745414d42414743797147534962345451454e0a4151494e416745414d42414743797147534962345451454e4151494f416745414d42414743797147534962345451454e41514950416745414d424147437971470a534962345451454e41514951416745414d42414743797147534962345451454e415149524167454c4d42384743797147534962345451454e41514953424241480a42774943417745414177414141414141414141414d42414743697147534962345451454e41514d45416741414d42514743697147534962345451454e415151450a42674341627755414144415042676f71686b69472b45304244514546436745424d42344743697147534962345451454e41515945454f6956736247464c5263450a4558367177655167324d30775241594b4b6f5a496876684e41513042427a41324d42414743797147534962345451454e415163424151482f4d424147437971470a534962345451454e41516343415145414d42414743797147534962345451454e415163444151482f4d416f4743437147534d343942414d4341306b414d4559430a4951446872316f59474b5a5874466b54764c636a766b46553871383746424c72636c413261445438644273737767496841493475763064494f632b782f4f41580a51792b483031524b54707537435265786852356b7542363842632f560a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436c6a4343416a32674177494241674956414a567658633239472b487051456e4a3150517a7a674658433935554d416f4743437147534d343942414d430a4d476778476a415942674e5642414d4d45556c756447567349464e48574342536232393049454e424d526f77474159445651514b4442464a626e526c624342440a62334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e564241674d416b4e424d5173770a435159445651514745774a56557a4165467730784f4441314d6a45784d4455774d5442614677307a4d7a41314d6a45784d4455774d5442614d484178496a41670a42674e5642414d4d47556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d45556c75644756730a49454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b474131554543417743513045780a437a414a42674e5642415954416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741454e53422f377432316c58534f0a3243757a7078773734654a423732457944476757357258437478327456544c7136684b6b367a2b5569525a436e71523770734f766771466553786c6d546c4a6c0a65546d693257597a33714f42757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f536347724442530a42674e5648523845537a424a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e5648513445466751556c5739640a7a62306234656c4153636e553944504f4156634c336c517744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159420a4166384341514177436759494b6f5a497a6a30454177494452774177524149675873566b6930772b6936565947573355462f32327561586530594a446a3155650a6e412b546a44316169356343494359623153416d4435786b66545670766f34556f79695359787244574c6d5552344349394e4b7966504e2b0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436a7a4343416a53674177494241674955496d554d316c71644e496e7a6737535655723951477a6b6e42717777436759494b6f5a497a6a3045417749770a614445614d4267474131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e760a636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a0a42674e5642415954416c56544d423458445445344d4455794d5445774e4455784d466f58445451354d54497a4d54497a4e546b314f566f77614445614d4267470a4131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e76636e4276636d46300a615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a42674e56424159540a416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a3044415163445167414543366e45774d4449595a4f6a2f69505773437a61454b69370a314f694f534c52466857476a626e42564a66566e6b59347533496a6b4459594c304d784f346d717379596a6c42616c54565978465032734a424b357a6c4b4f420a757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f5363477244425342674e5648523845537a424a0a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b63325679646d6c6a5a584d75615735300a5a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e564851344546675155496d554d316c71644e496e7a673753560a55723951477a6b6e4271777744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159424166384341514577436759490a4b6f5a497a6a3045417749445351417752674968414f572f35516b522b533943695344634e6f6f774c7550524c735747662f59693747535839344267775477670a41694541344a306c72486f4d732b586f356f2f7358364f39515778485241765a55474f6452513763767152586171493d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                runtimeData: hex"7b226b657973223a5b7b226b6964223a2248434c416b507562222c226b65795f6f7073223a5b227369676e225d2c226b7479223a22525341222c2265223a2241514142222c226e223a2238354a624a41414179426c647a4f716479683341506445367652485a4a3432365348437a4f794f6a5a346f6a454f62555f515f5a515930584570736e623759726f594a543645714543644b36353933374c6256416e566f6537386c78793161697a49673936333650354b555a2d59796a7250544f4d77784c6f32786a546168533549696d664379656c36564b3764543033636763776a48654d564b763232635838494e495343653553716f427433526e4345324e42416e5438714834774345414e3357384a39425f64464e486a696a46796153314c6e766b2d32787a67614a534b425f566743754c6964555172625867685954694c796c677959444f623478697830536f73303157684553766e6e54744930696676356f33584e683267436c6746786173537771656e5356436f38594161365f566c336236474f2d4f456b6b3566756d4e474f634d4a7537563344377a6b6a68673251227d2c7b226b6964223a2248434c456b507562222c226b65795f6f7073223a5b22656e6372797074225d2c226b7479223a22525341222c2265223a2241514142222c226e223a2274324961344141424c2d38653279565664534342304e715846776364627572334c5f61683761784e5838386b774c4d7353457a705f6d523239743671636363343836797648525749656e73427865324a4a6470506a46646f36437579673063526a466341554734505a6a70314a747a47615639794f545736646744714f394a68716a58696e42774f5434444b6e6355624f46396847764d4a764d7339697649506566484e42746241646158794b4d6168594c744a4c7a47486c4d4b3543465468316556516a2d5a7273536a5174766f43346e43465f314f57596362646956616339366c394c317873665779744955576154394154466a4d5a78634841723462422d356b534e6d52303568596162715a74535752644b4b722d584f2d506c674f656e374f614c596f394d5f6c43766d394b664b734e7939625159773670457070615268646a6139456951384d4864394c6b6a4b72314477227d5d2c22766d2d636f6e66696775726174696f6e223a7b22636f6e736f6c652d656e61626c6564223a747275652c22726f6f742d636572742d7468756d627072696e74223a22366e5a5a6e59614a63344b71555a5f7976412d6d75634664594e6f75766c506e49546e4e4d5873486c2d30222c227365637572652d626f6f74223a66616c73652c2274706d2d656e61626c6564223a747275652c2274706d2d706572736973746564223a66616c73652c22766d556e697175654964223a2231333237443838452d353543312d344542462d423131392d324237384634353242343044227d2c22757365722d64617461223a223030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030227d"
            }),
            userData: hex"d4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa30000000000000000000000000000000000000000000000000000000000000000"
        });

        bytes memory nonce = hex"00";
        AzureTDX.AkPub memory trustedAkPub = AzureTDX.AkPub({
            exponentRaw: 0,
            modulusRaw: hex"f3925b240000c8195dccea9dca1dc03dd13abd11d9278dba4870b33b23a3678a2310e6d4fd0fd9418d17129b276fb62ba18253e84a8409d2bae7ddfb2db5409d5a1eefc971cb56a2cc883deb7e8fe4a519f98ca3acf4ce330c4ba36c634da852e488a67c2c9e97a54aedd4f4ddc81cc231de3152afdb6717f083484827b94aaa01b77467084d8d0409d3f2a1f8c021003775bc27d07f7453478e28c5c9a4b52e7be4fb6c7381a252281fd5802b8b89d510adb5e08584e22f2960c980ce6f8c62c744a8b34d568444af9e74ed23489fbf9a375cd8768029601716ac4b0a9e9d2542a3c6006bafd59776fa18ef8e1249397ee98d18e70c26eed5dc3ef3923860d9"
        });

        AzureTDX.PCR[] memory pcrs = new AzureTDX.PCR[](24);
        for (uint256 i = 0; i < 24; i++) {
            pcrs[i] = AzureTDX.PCR(i, attestationDocument.attestation.tpmQuote.pcrs[i]);
        }

        AzureTDX.TrustedInput memory trustedInput = AzureTDX.TrustedInput({
            akPub: trustedAkPub,
            runtimeDataHash: sha256(attestationDocument.instanceInfo.runtimeData),
            pcrs: pcrs
        });

        bytes memory unverifiedTdxQuote = AzureTDX.verify(
            AzureTDX.VerifyParams({attestationDocument: attestationDocument, trustedInput: trustedInput, nonce: nonce})
        );
    }
}
